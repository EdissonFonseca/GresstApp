<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title>Sincronización</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Information section -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="sync-outline" color="primary"></ion-icon>
        Sincronización de Datos
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>
        Esta operación envía los datos locales pendientes al servidor y descarga las actualizaciones más recientes.
      </p>

      <!-- Pending messages counter -->
      <ion-item lines="none" *ngIf="pendingMessages() > 0">
        <ion-icon name="alert-circle-outline" slot="start" color="warning"></ion-icon>
        <ion-label>
          <h3>Cambios pendientes por sincronizar:</h3>
          <p><strong>{{ pendingMessages() }}</strong> {{ pendingMessages() === 1 ? 'registro' : 'registros' }}</p>
        </ion-label>
      </ion-item>

      <ion-item lines="none" *ngIf="pendingMessages() === 0">
        <ion-icon name="checkmark-circle-outline" slot="start" color="success"></ion-icon>
        <ion-label>
          <h3>Todos los datos están sincronizados</h3>
        </ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <!-- Synchronize button -->
  <ion-button
    expand="block"
    color="success"
    (click)="synchronize()"
    size="large"
    [disabled]="pendingMessages() === 0">
    <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
    Sincronizar con el Servidor
  </ion-button>

  <!-- Export option (shown when sync fails) -->
  <ion-card *ngIf="showExportOption()" color="light">
    <ion-card-header>
      <ion-card-title color="warning">
        <ion-icon name="cloud-offline-outline"></ion-icon>
        Sin Conexión al Servidor
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>
        <strong>No se pudo establecer conexión con el servidor.</strong>
      </p>
      <p>
        Si necesita cerrar la aplicación o enviar los datos de forma alternativa,
        puede exportar los cambios pendientes a un archivo y enviarlo por correo electrónico al equipo de soporte.
      </p>

      <ion-item lines="none">
        <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
        <ion-label class="ion-text-wrap">
          <h3>¿Qué se exportará?</h3>
          <p>Un archivo JSON con todos los cambios pendientes (procesos, subprocesos, tareas) que no se han podido sincronizar.</p>
        </ion-label>
      </ion-item>

      <ion-item lines="none">
        <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
        <ion-label class="ion-text-wrap">
          <h3>¿Cómo enviarlo?</h3>
          <p>Una vez exportado, envíe el archivo a <strong>soporte&#64;gresst.com</strong> y ellos lo procesarán manualmente.</p>
        </ion-label>
      </ion-item>

      <ion-button
        expand="block"
        color="primary"
        (click)="exportMessages()"
        [disabled]="pendingMessages() === 0">
        <ion-icon name="download-outline" slot="start"></ion-icon>
        Exportar Datos Pendientes
      </ion-button>

      <ion-note class="ion-padding-top ion-text-wrap">
        <ion-icon name="information-circle-outline"></ion-icon>
        <small>
          Los datos permanecerán en su dispositivo hasta que sean sincronizados exitosamente o hasta que cierre sesión forzadamente.
        </small>
      </ion-note>
    </ion-card-content>
  </ion-card>
</ion-content>
